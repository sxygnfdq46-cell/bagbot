name: e2e-redis

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

jobs:
  e2e-redis:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10

    env:
      REDIS_URL: redis://localhost:6379/0
      JOB_STORE: redis
      PROMETHEUS_MULTIPROC_DIR: /tmp/metrics

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest

      - name: Wait for Redis
        run: |
          python - <<'PY'
          import socket, time, sys
          host, port = "localhost", 6379
          deadline = time.time() + 60
          while time.time() < deadline:
              with socket.socket() as s:
                  try:
                      s.settimeout(1)
                      s.connect((host, port))
                      sys.exit(0)
                  except OSError:
                      time.sleep(1)
          sys.exit("Redis not ready")
          PY

      - name: Run e2e redis suite (tolerate missing tests until added)
        run: |
          pytest -m "e2e_redis" tests || status=$?
          if [ "${status:-0}" = "5" ]; then
            echo "No e2e_redis tests collected yet; skipping."; exit 0
          else
            exit "${status:-0}"
          fi
        shell: bash
