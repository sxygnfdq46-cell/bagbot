name: Deploy Dry Run (Build & Health Check)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend Docker image
        run: |
          cd bagbot
          docker build -t bagbot-backend:test -f backend/Dockerfile .

      - name: Build frontend Docker image
        run: |
          cd bagbot/frontend
          docker build -t bagbot-frontend:test .

      - name: Create test environment file
        run: |
          cat > .env.test << EOF
          SECRET_KEY=test-secret-key-for-ci-only
          ALLOWED_ORIGINS=http://localhost:3000
          LOG_LEVEL=INFO
          SENTRY_DSN=
          BINANCE_API_KEY=
          BINANCE_API_SECRET=
          EOF

      - name: Start backend container
        run: |
          docker run -d \
            --name bagbot-backend-test \
            --env-file .env.test \
            -p 8000:8000 \
            bagbot-backend:test

      - name: Wait for backend to be ready
        run: |
          echo "Waiting for backend to start..."
          for i in {1..30}; do
            if curl -f http://localhost:8000/api/health > /dev/null 2>&1; then
              echo "Backend is ready!"
              break
            fi
            echo "Attempt $i/30 - Backend not ready yet..."
            sleep 2
          done

      - name: Run health check
        run: |
          echo "Testing health endpoint..."
          response=$(curl -s -w "\n%{http_code}" http://localhost:8000/api/health)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "HTTP Status: $http_code"
          echo "Response Body: $body"
          
          if [ "$http_code" != "200" ]; then
            echo "❌ Health check failed with status $http_code"
            exit 1
          fi
          
          if echo "$body" | grep -q '"ok":true'; then
            echo "✅ Health check passed!"
          else
            echo "❌ Health check response invalid"
            exit 1
          fi

      - name: Show backend logs on failure
        if: failure()
        run: |
          echo "=== Backend Container Logs ==="
          docker logs bagbot-backend-test

      - name: Cleanup containers
        if: always()
        run: |
          docker stop bagbot-backend-test || true
          docker rm bagbot-backend-test || true

      - name: Image size report
        if: success()
        run: |
          echo "=== Docker Image Sizes ==="
          docker images | grep bagbot
